# FIGURES

(ref:fig-map-spawn) Canadian Yukon Chinook salmon Conservation Units and "major" and "minor" spawning locations as cataloged in @brown2017.

```{r fig-map-spawn, fig.cap = "(ref:fig-map-spawn)"}
knitr::include_graphics(here::here("csasdown/figure/yukon-map-spawn.png"))
```

(ref:fig-map-gsi) Locations of Chinook salmon genetic baseline samples in the Canadian portion of the Yukon River watershed. Sites are scaled to the number of samples collected to date.
```{r fig-map-gsi, fig.cap = "(ref:fig-map-gsi)"}
knitr::include_graphics(here::here("csasdown/figure/yukon-map-gsi.png"))
```

(ref:fig-map-assess) Sites of major assessment projects for adult Chinook salmon Canadian portion of the Yukon River watershed. A full list of assessment projects is provided in Table \@ref(tab:assess-proponents).
```{r fig-map-assess, fig.cap = "(ref:fig-map-assess)"}
knitr::include_graphics(here::here("csasdown/figure/yukon-map-assess.png"))
```

(ref:fig-trib-spawn) Estimates of spawner abundances over time by tributary assessment project. For more details on each assessment project see Table \@ref(tab:assess-proponents).

```{r fig-trib-spawn, fig.cap = "(ref:fig-trib-spawn)"}
knitr::include_graphics(here::here("csasdown/figure/trib-escape.png"))
```

(ref:fig-trib-vs-CU-spawn) Relationship between estimates of spawner abundance from select tributary scale assessment projects and run-reconstruction based estimates at the Conservation Unit scale. Linear model fit shown in grey. For more details on each assessment project and corresponding Conservation Units see Table \@ref(tab:assess-proponents).

```{r fig-trib-vs-CU-spawn, fig.cap = "(ref:fig-trib-vs-CU-spawn)"}
knitr::include_graphics(here::here("csasdown/figure/RR-vs-trib-spawners.png"))
```

(ref:fig-run-timing) Average annual daily passage (scaled to maximum) from Alaska into the Yukon Territory for each Conservation Unit. For reference, in a non-leap year the 180th, 210th and 240th day of the year correspond to 29 June, 29 July, and 28 August, respectively. 

```{r fig-run-timing, fig.cap = "(ref:fig-run-timing)"}
knitr::include_graphics(here::here("csasdown/figure/CU-run-timing.png"))
```
\clearpage

(ref:fig-CU-spawn) Reconstructed spawner abundance over time by Conservation Unit (median and 95% confidence intervals).

```{r fig-CU-spawn, fig.cap = "(ref:fig-CU-spawn)"}
knitr::include_graphics(here::here("csasdown/figure/cu-escape.png"))
```

(ref:fig-CU-SR) Relationship between spawner abundance and recruitment by Conservation Units. Individual spawner-recruitment pairs are color coded according to brood year with 80% credible intervals. The thick black line is the predicted median relationship between spawner abundance and recruitment along with 80% credible intervals in the shaded region. The replacement line, where spawners equals recruits is shown in grey. 

```{r fig-CU-SR, fig.cap = "(ref:fig-CU-SR)"}
knitr::include_graphics(here::here("csasdown/figure/SR_fits_AR1.png"))
```

(ref:fig-prod-trends) Estimated average intrinsic productivity (ricker $\alpha$ parameter; maximum recruits per spawner) over time by Conservation Unit. The dashed grey line is replacement.

```{r fig-prod-trends, fig.cap = "(ref:fig-prod-trends)"}
knitr::include_graphics(here::here("csasdown/figure/changing_productivity.png"))
```

(ref:fig-asl) Age, sex, length, and reproductive output trends in Canadian-origin Yukon River Chinook salmon over time. a) sex ratio, represented as proportion of spawners that are female, b) body length of female spawners (mid eye to tail fork length), c) proportion of returning spawners in each age class over time, d) average reproductive output of female spawners (eggs per female spawner).

```{r fig-asl, fig.cap = "(ref:fig-asl)"}
knitr::include_graphics(here::here("csasdown/figure/asl.png"))
```

(ref:fig-CU-EMR) Relationship between total egg mass of spawning females and recruitment by Conservation Units. Individual egg mass-recruitment pairs are color coded according to brood year with 80% credible intervals. The thick black line is the predicted median relationship between egg mass and recruitment along with 80% credible intervals in the shaded region. The replacement line, where spawners equals recruits is shown in grey.

```{r fig-CU-EMR, fig.cap = "(ref:fig-CU-EMR)"}
knitr::include_graphics(here::here("csasdown/figure/EM-R_fits.png"))
```

(ref:fig-em-vs-spw-sr-TVA) Scaled trends in intrinsic productivity index for two alternative recruitment models.

```{r fig-em-vs-spw-sr-TVA, fig.cap = "(ref:fig-em-vs-spw-sr-TVA)"}
knitr::include_graphics(here::here("csasdown/figure/spw-vs-em-SR-TVA.png"))
```

(ref:fig-rapid-status) Yukon Chinook Wild Salmon Policy statuses for years with applicable data. Each row summarizes the statuses available for each Conservation Unit in the Yukon River Stock Management Unit. The Porcupine Conservation Unit, which is provisionally assessed as in the Red status zone is not shown. 

```{r fig-rapid-status, fig.cap = "(ref:fig-rapid-status)"}
knitr::include_graphics(here::here("csasdown/figure/rapid-status.png"))
```

(ref:fig-smu-trends) Reconstructed (a) total run size (orange) and spawning escapement (grey), and (b) harvest rates for the Yukon River Stock Management Unit. Thick lines are medians and shaded areas indicate 95% credible intervals.

```{r fig-smu-trends, fig.cap = "(ref:fig-smu-trends)"}
knitr::include_graphics(here::here("csasdown/figure/SMU-run-esc.png"))
```

(ref:fig-enhance-proj) Total Chinook salmon releases by facility/type and Conservation Unit. Note: Location of brood collection and release location, by CU, are the same in all cases except for 250,529 fry from the Upper Yukon raised at the McIntyre Cr facility and released in the Tatchun River (Middle Yukon River and tributaries Conservation Unit) between 2006-2011.

```{r fig-enhance-proj, fig.cap = "(ref:fig-enhance-proj)"}
knitr::include_graphics(here::here("csasdown/figure/hatch_bar.png"))
```

(ref:fig-wh-fishway) Chinook returns to Whitehorse Rapids fishway and proportion hatchery origin spawners (pHOS), based on observed adipose fin clip rates. Proportionate Natural Influence (PNI) for the last six years, calculated from adipose fin clip status and Parentage Based Tagging (PBT) results of broodstock, when available. 

```{r fig-wh-fishway, fig.cap = "(ref:fig-wh-fishway)"}
knitr::include_graphics(here::here("csasdown/figure/hatch_prop.png"))
```

(ref:fig-schematic) Illustration of steps in the closed loop simulations that were used to quantify future biological and fishery consequences of current and alternative harvest management measures.

```{r fig-schematic, fig.cap = "(ref:fig-schematic)"}
knitr::include_graphics(here::here("csasdown/figure/sim-schematic.png"))
```

(ref:fig-prod-scenarios) Alternative operating model productivity scenarios considered in the closed-loop simulations including the reference (base case) scenario, the 10-year average of recent $\alpha$ (2007-2017 brood years), and robustness scenario, the most recent $\alpha$ (2017 brood year).
```{r fig-prod-scenarios, fig.cap = "(ref:fig-prod-scenarios)"}
knitr::include_graphics(here::here("csasdown/figure/OM-productivity-scenarios.png"))
```

(ref:fig-hcrs) Illustration of the suite of harvest control rules considered in the closed-loop simulations. See Table \@ref(tab:hcrs) for description of each harvest control rule. The x-axis range in the plot corresponds approximately to the historical range of Canadian-origin Yukon Chinook salmon run sizes.

```{r fig-hcrs, fig.cap = "(ref:fig-hcrs)"}
knitr::include_graphics(here::here("csasdown/figure/HCR_visualize.png"))
```
\clearpage

(ref:fig-projections) Projected spawner abundance over time (median and 50th percentiles) by Conservation Unit under three alternative fishery management measures, and the reference (base case) operating model productivity scenario. The last 6 years of observed spawners are shown prior to projections. Red and green dashed lines correspond to proposed lower and upper biological reference points for each CU (20%$S_{MSR}$ and $S_{MSR}$, respectively) based on analyses that explicitly took demographic characteristics into account. 

```{r fig-projections, fig.cap = "(ref:fig-projections)"}
knitr::include_graphics(here::here("csasdown/figure/S-fwd_simple_grp_TVA.png"))
```

\clearpage

(ref:fig-ER-tradeoff-ref) Projected consequences of a range of fixed exploitation rates from the closed loop simulations under the 'reference' (base case) operating model scenario. (a) Mean number of Conservation Units that fall above, below, and between their reference points (20% $S_{MSR}$ and $S_{MSR}$ based on analyses that explicitly took demographic characteristics into account) in the final simulated year (2050), over 1000 iterations. (b) Mean spawner abundance and (c) mean harvest, by Conservation Units, over all simulation years (2025-2050).

```{r fig-ER-tradeoff-ref, fig.cap = "(ref:fig-ER-tradeoff-ref)"}
knitr::include_graphics(here::here("csasdown/figure/fixed_ER_tradeoffs_TVA.png"))
```

\clearpage

(ref:fig-perf-ref) Performance of alternative harvest control rules the reference (base case) operating model productivity scenario. (a) Median (coloured bars) and 50% quantiles (vertical lines) of performance measures calculated over the years 2030-2050 and 1000 replicate simulations. (b) Mean number of Conservation Units that fall above, below, and between reference points (20% $S_{MSR}$ and $S_{MSR}$ based on analyses that explicitly took demographic characteristics into account) in the final simulated year (2050), over replicate simulations.

```{r fig-perf-ref, fig.cap = "(ref:fig-perf-ref)"}
knitr::include_graphics(here::here("csasdown/figure/perf_metrics_status_TVA.png"))
```

\clearpage



# TABLES

(ref:tab-cons-unit-smu) Stock Management and Conservation Units that make up the Yukon Chinook major fish stock prescribed under the Fish Stock Provisions of Canada's *Fisheries Act*. The average annual contribution of each Conservation Unit to the Yukon Chinook salmon Stock Management Unit based on genetics is also shown. 
```{r tab-cons-unit-smu, results='asis'}
smucutable <- read.csv(here::here("csasdown/data/tab-cons-unit-smu.csv"))
names(smucutable) <- gsub("\\.", " ", names(smucutable))
names(smucutable)[4] <- "Average Contribution (1984-2024)"
names(smucutable)[3] <- "Conservation Unit"
names(smucutable)[2] <- "Conservation Unit ID"


smucutable |> 
  dplyr::mutate_all(function(x){gsub("\\\\.", " ", x)}) |>
  dplyr::mutate_all(function(x){gsub("\\\\n","\n", x)}) |>
  dplyr::mutate_all(function(x){gsub("%", "\\\\%", x)}) |>
  csasdown::csas_table(format = "latex",
                       escape = FALSE,
                     caption = "(ref:tab-cons-unit-smu)", 
                     repeat_header = TRUE) |>
    kableExtra::column_spec(1, width = "3cm")|>
    kableExtra::column_spec(2, width = "2cm")|>
    kableExtra::column_spec(3, width = "4cm")|>
    kableExtra::column_spec(4, width = "2cm")
```

\clearpage
(ref:tab-CU-gsi-annual-summary) Annual proportion of total Chinook salmon passing from Alaska into the Yukon Territory for each Conservation Unit over time. These estimates are based on the raw genetic stock identification assignments. Note that this accounts for genetic assignment uncertainty (i.e., sums across all probabilities and the re-scales by sample size for a given year) but is unweighted by border passage (i.e., does not account for incomplete sampling of return migration; Figure \@ref(fig:fig-gsi-samples)).
```{r tab-CU-gsi-annual-summary, results="asis"}

cugsitable <- read.csv(here::here("csasdown/data/CU-gsi-annual-summary.csv"))
names(cugsitable) <- gsub(".", " ", names(cugsitable), fixed=T)


cugsitable |> 
  dplyr::mutate_all(function(x){round(x, 3)}) |>
  csasdown::csas_table(format = "latex",
                       escape = FALSE,
                       caption = "(ref:tab-CU-gsi-annual-summary)", 
                       repeat_header = TRUE) |>
  kableExtra::column_spec(-1, width = "1.5cm")


```

\clearpage
\begin{landscapepage}
(ref:assess-proponents) Chinook salmon adult assessment projects in the Canadian portion of the Yukon River basin.  

```{r assess-proponents, results = "asis"}

assess_tbl <- read.csv(file=here::here("csasdown/data/trib-assessment-propnents.csv")) |> select(-Contemporary.initiation)
names(assess_tbl) <- gsub(".", " ", names(assess_tbl), fixed=TRUE)
names(assess_tbl)[4] <- "Conservation Unit"

assess_tbl |> 
  mutate_at(c(2,5), function(x){str_to_sentence(x)}) |>
  drop_na() |> 
  
  csasdown::csas_table(format = "latex",
                       caption = "(ref:assess-proponents)",
                       repeat_header = TRUE,
                       align = "llc") |>
  kableExtra::column_spec(1, width = "3cm") |>
  kableExtra::column_spec(2, width = "3cm") |>
  kableExtra::column_spec(3, width = "7cm") |>
  kableExtra::column_spec(4, width = "3cm") |>
  kableExtra::column_spec(5, width = "2cm") |>
  kableExtra::column_spec(6, width = "3cm")|>
  kableExtra::footnote(general=c("*Project provides in-season information on returning spawners."))
```
\end{landscapepage}


\clearpage

(ref:tab-perf-metrics-descriptions) Biological and fishery performance measures considered in the closed-loop simulations to assess the performacne of alternative fishery management measures.

```{r tab-perf-metrics-descriptions, results = "asis"}
df <- data.frame(Metric = c("Number of CUs below their lower biological reference point", 
                            "Number of CUs above their upper biological reference point", 
                            "Average annual aggregrate spawning escapement", 
                            "Average annual harvest", 
                            "Average annual harvest rate", 
                            "Proportion of years with no harvest", 
                            "Proportion of years Basic Needs Allocation met"), 
                 Description = c("Number of Conservation Units (CUs; $i$) with spawner abundance ($S$) at end of simulations that falls below CU specific lower biological refernece point, defined as 20% of the spawner abundance associated with maximum returns when demographic characteristics over most recent decade are explicitly taken into account (20%$S_{MSR,em_{2014-2024}}$)",
                                 "Number of Conservation Units (CUs) with spawner abundance at end of simulations that is above CU specific upper biological refernece point, defined as spawner abundance associated with maximum returns when demographic characteristics over most recent decade are explicitly taken into account ($S_{MSR,em_{2014-2024}}$)",
                                  "Average spawner abundance across all CUs across replicate simulation and years, where $n$ rep is the number of replicate simulations and $t_1$ and $t_2$ are the first and last years over which the metric is calculated", 
                                  "Average annual harvest ($H$) across all CUs across replicate simulation and years", 
                                  "Average annual harvest rate ($U$) for stock aggregrate across replicate simulation and years", 
                                  "Proportion of years across replicate simulation and years with no harvest", 
                                  "Proportion of years across replicate simulation and years Basic Needs Allocation (BNA)met"),
                 Equation = c("$\\sum_i S_{i,t=2050}<0.2S_{MSR,i,em_{2014-2024}}$", 
                              "$\\sum_i S_{i,t=2050}>S_{MSR,i,em_{2014-2024}}$", 
                              "$\\frac{\\sum_i\\sum_{\\substack{n_{rep}\\\\n=1}}\\sum_{\\substack{t_1\\\\t_2}}S_{i,t}}{t_2-t_1+1}$", 
                              "$\\frac{\\sum_i\\sum_{\\substack{n_{rep}\\\\n=1}}\\sum_{\\substack{t_1\\\\t_2}}H_{i,t}}{t_2-t_1+1}$", 
                              "$\\frac{\\sum_{\\substack{t_1\\\\t_2}}U_{t}}{t_2-t_1+1}$",
                              "$\\frac{\\sum_i\\sum_{\\substack{n_{rep}\\\\n=1}}\\sum_{\\substack{t_1\\\\t_2}}H_{i,t}=0}{t_2-t_1+1}$",
                              "$\\frac{\\sum_i\\sum_{\\substack{n_{rep}\\\\n=1}}\\sum_{\\substack{t_1\\\\t_2}}H_{i,t}>BNA}{t_2-t_1+1}$"))
df|>
   dplyr::mutate_all(function(x){gsub("&", "\\\\&", x)}) |> 
   dplyr::mutate_all(function(x){gsub("%", "\\\\%", x)}) |>
   dplyr::mutate_all(function(x){gsub("\\\\n","\n", x)}) |>
  csasdown::csas_table(format = "latex",
                     caption = "(ref:tab-perf-metrics-descriptions)", 
                     repeat_header = TRUE, 
                     align = "llc")|>
  kableExtra::column_spec(1, width = "3.5cm")|>
  kableExtra::column_spec(2, width = "6.5cm")
```

\clearpage


(ref:ref-points) Definitions of some common biological reference points used for salmon at either Stock Management Unit or Conservation Unit scale.

```{r ref-points, results = "asis"}
priors.df <- data.frame(Reference = c("Limit Reference Point (LRP)", 
                                               "Upper Stock Reference Point (USR)", 
                                               "Removal Reference Point", 
                                               "Lower stock reference point", 
                                               "Lower Wild Salmon Policy biological benchmark ", 
                                               "Upper Wild Salmon Policy biological benchmark ",
                                               "Other biological reference points"), 
                        Scale = c("Stock Management Unit", 
                                     "Stock Management Unit", 
                                     "Stock Management Unit or Conservation Unit", 
                                     "Stock Management Unit", 
                                     "Conservation Unit", 
                                     "Conservation Unit",
                                     "Stock Management Unit or Conservation Unit"),
                           Definition = c("CU-status based; an SMU is below its LRP when one or more component CUs are in the WSP Red status zone. This definition is aligned with principle that LRPs be aligned with Canada’s WSP objective of preserving biodiversity of salmon at the scale of CUs (DFO 2022; Holt et al. 2023a). However, it is difficult to operationalize this type of LRP for fisheries management, and so for management purposes an LRP-Lower may also be required. ",
                                          "Spawning abundance associated with fully meeting socio-economic objectives for the system, and above which maximum allowable harvest rates (see Removal Reference Point) can be sustained. Under the DFO Precautionary Approach Framework this is often 80% of $S_{MSY}$, but this is not a requirement and may vary by system depending on the fishery and broader socio-economic and ecosystem objectives. ",
                                          "The maximum acceptable harvest rate the SMU can be subject to; is typically set to be less than or equal to the removal rate associated with maximum sustainable yield ($U_{MSY}$).", 
                                          "Aggregate SMU spawner abundance below which all fishery removals should be limited to the maximum extent possible and below which there is a high risk of serious and irreversible harm to the stock. This type of reference point is helpful for informing management since assessment and fishery decisions are often abundance based and so can be operationalized.", 
                                          "Differentiates amber and red Wild Salmon Policy status zones. Assessing WSP rapid statuses considers multiple metrics, and this is one metric that is applied if the data and related benchmarks are available. When it can be estimated $S_{GEN}$ is often used and it is the spawning abundance that is expected to lead to recovery to $S_{MSY}$ in one salmon generation in the absence of fishing under equilibrium conditions (Holt 2009). Spawning abundances below this reference point (red status) are expected to be associated with high risk of irreversible harm to the CU and align with a COSEWIC assessment of “endangered”. ",
                                          "The spawning abundance that differentiates amber and green Wild Salmon Policy status zones. When it can be estimated 80% $S_{MSY}$ is used and is the spawner abundance expected to provide, on average annual basis, the maximum annual catch for the CU, given existing environmental conditions and where “there would not be a high probability of losing the CU” (DFO 2005).",
                                          "Other biologically based reference points like $S_{MSR}$, which is the spawner abundance expected to maximize returns on average annual basis, may be used as an upper biological reference point and 20% of $S_{MSR}$ which has been proposed as a lower biological reference point. $S_{MSR}$ is sometimes referred to as $S_{MAX}$, and escapement goals based on this quantity are sometimes deemed more appropriate where the fishery is dominated by subsistence fisheries that wish to harvest a fixed number of fish each year and are attempting to minimize the effort needed to harvest (Liller and Savereide 2022)."))

priors.df |>
   dplyr::mutate_all(function(x){gsub("&", "\\\\&", x)}) |> 
   dplyr::mutate_all(function(x){gsub("%", "\\\\%", x)}) |>
   dplyr::mutate_all(function(x){gsub("\\\\n","\n", x)}) |>
  csasdown::csas_table(format = "latex",
                     caption = "(ref:ref-points)", 
                     repeat_header = TRUE) |>
    kableExtra::column_spec(1, width = "3cm")|>
    kableExtra::column_spec(2, width = "3cm")|>
    kableExtra::column_spec(3, width = "10cm")
```

\clearpage
(ref:pars-ref-pts) Estimates of biological reference points by Conservation Unit. Values are in thousands of fish (except $U_{MSY}$).

```{r pars-ref-pts, results = "asis"}
bench.pars <- read.csv(here::here('analysis/data/generated/bench_par_table.csv'))

bench.pars[bench.pars$bench.par != "Umsy", 3:6] <- bench.pars[bench.pars$bench.par != "Umsy", 3:6]/1000

bench.pars <- bench.pars |> 
  dplyr::mutate_at(3:6, function(x){round(x, 2)}) |>
  dplyr::mutate(value=paste0(X50., " (", X10., ",", X90., ")")) |>
  dplyr::relocate(value, .after=bench.par) |>
  dplyr::mutate(Rhat = format(round(Rhat, 4)))


names(bench.pars) <- c("Conservation Unit",
                       "Benchmark",
                       "Median (80$^{\\text{th}}$ percentile)",
                       "Mean", "Median",
                       "Quantile 10", "Quantile 90", 
                       "Effective Sample Size ($N_{\\text{eff}}$)",
                       "Chain Mixing ($\\widehat{R}$)")
bench.pars$Benchmark[bench.pars$Benchmark == "Sgen"]<- "$S_{\\text{GEN}}$"
bench.pars$Benchmark[bench.pars$Benchmark == "Smsr"]<- "$S_{\\text{MSR}}$"
bench.pars$Benchmark[bench.pars$Benchmark == "Smsy"]<- "$S_{\\text{MSY}}$"
bench.pars$Benchmark[bench.pars$Benchmark == "Umsy"]<- "$U_{\\text{MSY}}$"

bench.pars |> 
  dplyr::filter(Benchmark %in% c("$S_{\\text{GEN}}$", "$S_{\\text{MSR}}$", "$S_{\\text{MSY}}$", "$U_{\\text{msy}}$")) |>
  dplyr::arrange(`Conservation Unit`) |>
  dplyr::select(c(1:3)) |>
  dplyr::mutate_at(.vars=1:2, function(x){gsub("\\.", " ", x)}) |>
  dplyr::mutate_all(function(x){gsub("&", "\\\\&", x)}) |> 
  dplyr::mutate_all(function(x){gsub("%", "\\\\%", x)}) |>
  dplyr::mutate_all(function(x){gsub("\\\\n","\n", x)}) |>
  csasdown::csas_table(format = "latex",
                     caption = "(ref:pars-ref-pts)", 
                     repeat_header = TRUE,
                     align = "llc",
                     booktabs = T) |>
  kableExtra::collapse_rows(columns=1, latex_hline = "major")
  

```


\clearpage
(ref:pars-sr) Estimates of key spawner-recruitment relationship parameters by Conservation Unit along with two measures of parameter estimability and model convergence. 

```{r pars-sr, results = "asis"}
bench.pars <- read.csv(here::here('analysis/data/generated/bench_par_table.csv'))

bench.pars$CU <- gsub(".", " ", bench.pars$CU, fixed=TRUE)
bench.pars$bench.par <- gsub(".", "", bench.pars$bench.par, fixed=TRUE)

bench.pars <- bench.pars |> 
  dplyr::mutate_at(3:6, function(x){round(x, 2)}) |>
  dplyr::mutate(value=paste0(X50., " (", X10., ",", X90., ")")) |>
  dplyr::relocate(value, .after=bench.par) |>
  dplyr::mutate(Rhat = format(round(Rhat, 4)))
  

names(bench.pars) <- c("Conservation Unit",
                       "Parameter",
                       "Median (80$^{\\text{th}}$ percentile)",
                       "Mean", "Median",
                       "Quantile 10", "Quantile 90", 
                       "Effective Sample Size ($N_{\\text{eff}}$)",
                       "Chain Mixing ($\\widehat{R}$)")
bench.pars$Parameter[bench.pars$Parameter == "alpha"]<- "$\\alpha$"
bench.pars$Parameter[bench.pars$Parameter == "beta"]<- "$\\beta$"
bench.pars$Parameter[bench.pars$Parameter == "phi"]<- "$\\phi$"
bench.pars$Parameter[bench.pars$Parameter == "sigma"]<- "$\\sigma$"

bench.pars |> 
  dplyr::select(c(1:3,8:9)) |>
  dplyr::filter(Parameter %in% c("$\\alpha$", "$\\beta$", "$\\phi$", "$\\sigma$")) |>
  dplyr::arrange(`Conservation Unit`) |>
  dplyr::mutate_all(function(x){gsub("&", "\\\\&", x)}) |> 
  dplyr::mutate_all(function(x){gsub("%", "\\\\%", x)}) |>
  dplyr::mutate_all(function(x){gsub("\\\\n","\n", x)}) |>
  csasdown::csas_table(format = "latex",
                     caption = "(ref:pars-sr)", 
                     repeat_header = TRUE,
                     align = "llc") |>
  kableExtra::collapse_rows(columns=1, latex_hline = "major") |>
  kableExtra::column_spec(1, width = "4cm") |>
  kableExtra::column_spec(3, width = "3cm") |>
  kableExtra::column_spec(4:5, width = "2cm") |>
  kableExtra::row_spec(1:108, align = "c")
  

```

\clearpage

(ref:demo-ref-pts) Biological reference points based on estimated egg mass-recruitment relationships by Conservation Unit. Values are in thousands of fish, and shown are reference points assuming different age, size and sex composition observed in the first six years of time series ("Early"), last six years of time series ("Recent"), or averaged over all years .

```{r demo-ref-pts, results = "asis"}
demo.pars <- read.csv(here::here('analysis/data/generated/demographic_parameters.csv'))

demo.pars <- demo.pars |> 
  dplyr::mutate(period = dplyr::case_when(period == "avg" ~ "Average (all years)",
                                          period == "early" ~ "Early (1985-1990)",
                                          period == "recent" ~ "Recent (2019-2024)")) |>
  mutate_at(4:6, function(x){round(x/1000, 2)}) |>
  dplyr::mutate(`Median (80$^{\\text{th}}$ percentile)` = paste0(median, " (", lower, ",", upper, ")"))

names(demo.pars)[1:6] <- c("Conservation Unit",
                           "Period",
                           "Benchmark",
                           "Median",
                           "Lower Quantile", "Upper Quantile")
demo.pars$Benchmark[demo.pars$Benchmark == "Sgen"]<- "$S_{\\text{GEN}}$"
demo.pars$Benchmark[demo.pars$Benchmark == "Smsr"]<- "$S_{\\text{MSR}}$"
demo.pars$Benchmark[demo.pars$Benchmark == "Smsy"]<- "$S_{\\text{MSY}}$"

demo.pars |> 
  dplyr::select(c(1:3,7)) |>
  dplyr::relocate(Benchmark, .after=`Conservation Unit`) |>
  dplyr::arrange(`Conservation Unit`) |>
  dplyr::mutate_at(.vars=1:2, function(x){gsub("\\.", " ", x)}) |>
  dplyr::mutate_all(function(x){gsub("&", "\\\\&", x)}) |> 
  dplyr::mutate_all(function(x){gsub("%", "\\\\%", x)}) |>
  dplyr::mutate_all(function(x){gsub("\\\\n","\n", x)}) |>
  csasdown::csas_table(format = "latex",
                     caption = "(ref:demo-ref-pts)", 
                     repeat_header = TRUE,
                     align = "llc") |>
  kableExtra::collapse_rows(columns=1, latex_hline = "major")

```

\clearpage

(ref:tab-factors-summary) Summary of anthropogenic, ecosystem, and climate factors affecting hypothesized to influence Canadian-origin Yukon Chinook salmon.

```{r tab-factors-summary, results="asis"}
# spawners
factors_spwn <- c("Water temperature", "Discharge/flow levels",
             "Ichthypohonus hoferi (pathogen)", "Thiamine deficiency complex (TDC)")
desc_spwn <- c("Temperatures >18C cause heat stress and impact spawning success",
               "Low flow reduce spawning success via higher temperature, habitat fragmentation",
               "Primarily infects maturing adults in the marine environment, potentially high mortality during spawning migration",
               "Low thiamine in adults has transgenerational effects")
refs_spwn <- c("Feddern et al. 2024; Murdoch et al. 2024", "Howard and von Biela 2023; Neuswanger et al. 2015", "Carroll and Liller 2023; Murphy et al. 2023; 2024; Kocan et al. 2004", "Larson and Howard 2019; Howard and von Biela 2023")

  
# egg  
factors_egg <- c("Stream flow", "Winter stream temperature")
desc_egg <- c("High flows scour streambeds, reducing egg survival ",
              "Cold and/or long winters reduce incubation survival")
refs_egg <- c("Feddern et al. 2024", "Murdoch et al. 2020; 2024")

# fry / smolt
factors_frysmolt <- c("Aufeis (icing)", "Stream flow / precipitation", 
                      "Ice out date", "Hydroelectric dam", "Placer mining")
desc_frysmolt <- c("Reduced or halted streamflow from ice formations decreases fry survival",
                   "High streamflow (high precipitation) may reduce foraging efficiency", 
                   "Early ice-out allows earlier outmigration", 
                   "Fry/smolts pass through dam, decreasing downstream survival",
                   "Sediment deposition and suspension can decrease egg and fry survival")
refs_frysmolt <- c("von Finster et al. 2025; in press", "Murdoch et al. 2024; Feddern et al. 2024", "Murdoch et al. 2024; Cunningham et al. 2018; Feddern et al. 2024", "Twardek et al. 2023b","Jensen et al. 2009; von Finster et al. in press")

# juvenile
factors_juvenile <- c("Sea surface temperature - winter", "Sea ice cover", "Predation")
desc_juvenile <- c("Colder first winters result in less productivity", 
                   "Productivity is lower in years when ice persists in the Bering Sea later",
                   "Increase in apex predator abundance")
refs_juvenile <- c("Feddern et al. 2024", "Feddern et al. 2024; Murdoch et al. 2024", "Ohlberger et al. 2019")

# adults
factors_adult <- c("Pink salmon competition", "Prey quality")
desc_adult <- c("Abundant pink salmon cause trophic cascades in the Bering Sea",
                "Declining prey quality in the Eastern Bering Sea hypothesized to be the cause of thiamine deficiency in spawning adults")
refs_adult <- c("Ruggerone et al. 2016; Cunningham et al. 2018", "Howard and von Biela 2023")

# make whole table
factors.df <- data.frame("Life_stage" = c(rep("Spawner", length(factors_spwn)),
                                        rep("Egg", length(factors_egg)),
                                        rep("Fry / smolt", length(factors_frysmolt)),
                                        rep("Juvenile", length(factors_juvenile)),
                                        rep("Adult", length(factors_adult))
                                        ),
                         "Anthropogenic,_ecosystem,_or_climate_factor" = 
                           c(factors_spwn, factors_egg, factors_frysmolt, 
                             factors_juvenile, factors_adult),
                         "Description_or_hypothesis" = c(desc_spwn, desc_egg, 
                                                         desc_frysmolt, desc_juvenile,
                                                         desc_adult),
                         "References" = c(refs_spwn, refs_egg, refs_frysmolt, refs_juvenile, refs_adult)
                         )

names(factors.df) <- gsub("_", " ", names(factors.df))
names(factors.df) <- gsub(".", ",", names(factors.df), fixed = TRUE)


factors.df |>
  dplyr::mutate_all(function(x){gsub("\\\\.", " ", x)}) |>
  dplyr::mutate_all(function(x){gsub("\\\\n","\n", x)}) |>
  csasdown::csas_table(format = "latex",
                       escape = FALSE,
                     caption = "(ref:tab-factors-summary)", 
                     repeat_header = TRUE) |>
    kableExtra::column_spec(1, width = "2cm")|>
    kableExtra::column_spec(2, width = "3cm")|>
    kableExtra::column_spec(3, width = "6.5cm")|>
    kableExtra::column_spec(4, width = "5cm") |>
    kableExtra::collapse_rows(columns=1, latex_hline = "major")
```


\clearpage
(ref:hcrs) Descriptions of the alternative fishery management measures (aka Harvest Control Rules) considered in the closed loop simulations.

```{r hcrs, results = "asis"}
HCR.df <- data.frame(HarvestControlRule = c("Moratorium", 
                                               "IMEG", 
                                               "Moratorium w/ harvest cap", 
                                               "IMEG w/ harvest cap", 
                                               "Precationary Approach alternative"), 
                        Description = c("Current moratorium on all directed harvest unless run-sizes are forecast to exceed 71,000 fish", 
                                     "Interim Management Escapement goal (IMEG) that was in place prior to the current moratorium. At forecasts below 42,500 fish no directed harvest and target harvest equal to 'surplus' if forecast exceeds escapement goal", 
                                     "Current moratorium unless run-sizes are forecast to exceed 71,000 fish in which case there is a harvest rate cap at large run-sizes that is equal to $U_{MSY}$ of the least productive Conservation Unit", 
                                     "Interim Management Escapement goal with a harvest rate cap at large run-sizes that is equal to $U_{MSY}$ of the least productive Conservation Unit (~40%)",
                                     "Harvest Control Rule that is consistent with DFO's Precautioanry Approach Framework (DFO 2009): no harvest below lower fishery reference point [19,000] with progressive increase in allowable harvest rate up to maximum equal to $U_{MSY}$ of the least productive Conservation Unit when run-sizes reach spawner abundances associated with the Upper Stock Reference Point [95,000]"))

colnames(HCR.df)[1] <- "Harvest Control Rule"

HCR.df |>
   dplyr::mutate_all(function(x){gsub("&", "\\\\&", x)}) |> 
   dplyr::mutate_all(function(x){gsub("%", "\\\\%", x)}) |>
   dplyr::mutate_all(function(x){gsub("\\\\n","\n", x)}) |>
  csasdown::csas_table(format = "latex",
                     caption = "(ref:hcrs)", 
                     repeat_header = TRUE) |>
    kableExtra::column_spec(1, width = "4cm")|>
    kableExtra::column_spec(2, width = "10cm")
```

\clearpage
\begin{landscapepage}
(ref:tab-ref-perf-measures) Consequences of alternative Harvest Control Rules based on range of biological and fishery performance measures (Table \@ref(tab:tab-perf-metrics-descriptions)) under the reference (base case) productivity operating model scenario.

```{r tab-ref-perf-measures, results = "asis"}

ref_case_pms <- read.csv(here::here("analysis/data/generated/perf_metrics_TVA.csv")) |>
  tidyr::pivot_longer(cols=2:10, values_to="value", names_to="metric") |>
  tidyr::pivot_wider(values_from="value", names_from="prob")
perf_metric_desc <- read.csv(here::here("csasdown/data/names_lookup.csv")) # to link metric names

fix_hcr <- unique(ref_case_pms$HCR)[grepl("^fixed.", unique(ref_case_pms$HCR))]

ref_case_pms[ref_case_pms$metric %in% c("escapement", "harvest"),3:6] <- ref_case_pms[ref_case_pms$metric %in% c("escapement", "harvest"),3:6]/1000 # put esc and harvest in units of x1000 fish

ref_case_pms <- ref_case_pms |> 
  dplyr::left_join(perf_metric_desc[,1:2], by=c("metric" = "metric_name")) |>
  dplyr::select(-metric) |>
  dplyr::relocate(Metric, .after="HCR") |>
  dplyr::filter(!(HCR %in% fix_hcr)) |>  # filter out fixed harvest 
  dplyr::mutate_at(3:6, function(x){round(x, 2)}) |>
  dplyr::mutate(value=paste0(median, " (", q_25, ",", q_75, ")")) |>
  dplyr::select(c(1:2,6:7))

names(ref_case_pms) <- c("Harvest Control Rule", "Performance measure", "Mean", "Median (50$^{\\text{th}}$ percentiles)")

ref_case_pms |> 
  dplyr::mutate_all(function(x){gsub("&", "\\\\&", x)}) |> 
  dplyr::mutate_all(function(x){gsub("%", "\\\\%", x)}) |>
  dplyr::mutate_all(function(x){gsub("\\\\n","\n", x)}) |>
  csasdown::csas_table(format = "latex",
                       caption = "(ref:tab-ref-perf-measures)", 
                       repeat_header = TRUE,
                       align = "llc") |>
kableExtra::collapse_rows(columns=1, latex_hline = "major")

```

\clearpage
(ref:tab-rob-perf-measures) Consequences of alternative Harvest Control Rules based on range of biological and fishery performance measures (Table \@ref(tab:tab-perf-metrics-descriptions)) under the robustness (worst case) productivity operating model scenario.


```{r tab-rob-perf-measures, results = "asis"}
rob_case_pms <- read.csv(here::here("analysis/data/generated/perf_metrics_TVA2.csv"))|>
  tidyr::pivot_longer(cols=2:10, values_to="value", names_to="metric") |>
  tidyr::pivot_wider(values_from="value", names_from="prob")
perf_metric_desc <- read.csv(here::here("csasdown/data/names_lookup.csv")) # to link metric names

fix_hcr <- unique(rob_case_pms$HCR)[grepl("^fixed.", unique(rob_case_pms$HCR))]

rob_case_pms[rob_case_pms$metric %in% c("escapement", "harvest"),3:6] <- rob_case_pms[rob_case_pms$metric %in% c("escapement", "harvest"),3:6]/1000 # put esc and harvest in units of x1000 fish

rob_case_pms <- rob_case_pms |> 
  dplyr::left_join(perf_metric_desc[,1:2], by=c("metric" = "metric_name")) |>
  dplyr::select(-metric) |>
  dplyr::relocate(Metric, .after="HCR") |>
  dplyr::filter(!(HCR %in% fix_hcr)) |>  # filter out fixed harvest 
  dplyr::mutate_at(3:6, function(x){round(x, 2)}) |>
  dplyr::mutate(value=paste0(median, " (", q_25, ",", q_75, ")")) |>
  dplyr::select(c(1:2,6:7))

names(rob_case_pms) <- c("Harvest Control Rule", "Performance measure", "Mean", "Median (50$^{\\text{th}}$ percentiles)")

rob_case_pms |> 
  dplyr::mutate_all(function(x){gsub("&", "\\\\&", x)}) |> 
  dplyr::mutate_all(function(x){gsub("%", "\\\\%", x)}) |>
  dplyr::mutate_all(function(x){gsub("\\\\n","\n", x)}) |>
  csasdown::csas_table(format = "latex",
                       caption = "(ref:tab-rob-perf-measures)", 
                       repeat_header = TRUE,
                       align = "llc") |>
kableExtra::collapse_rows(columns=1, latex_hline = "major")


```
\end{landscapepage}
