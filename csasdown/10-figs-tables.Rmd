---
output:
  pdf_document: default
  html_document: default
---
#  FIGURES

(ref:fig-map-spawn) Yukon Chinook salmon Conservation Units and "major" and "minor" spawning locations as cataloged in @brown2017.

```{r fig-map-spawn, fig.cap = "(ref:fig-map-spawn)"}
knitr::include_graphics(here::here("csasdown/figure/yukon-map-spawn.png"))
```

(ref:fig-map-gsi) Locations of Chinook salmon genetic baseline samples in the Canadian portion of the Yukon River watershed. Sites are scaled to the number of samples collected to date.
```{r fig-map-gsi, fig.cap = "(ref:fig-map-gsi)"}
knitr::include_graphics(here::here("csasdown/figure/yukon-map-gsi.png"))
```

(ref:fig-map-assess) Major assessment projects for adult Chinook salmon in the Canadian portion of the Yukon River watershed. A full list of assessment projects is provided in Table \@ref(tab:assess-proponents).
```{r fig-map-assess, fig.cap = "(ref:fig-map-assess)"}
knitr::include_graphics(here::here("csasdown/figure/yukon-map-assess.png"))
```

(ref:fig-trib-spawn) Estimates of spawner abundances over time by tributary assessment project. For more details on each assessment project see Table \@ref(tab:assess-proponents).

```{r fig-trib-spawn, fig.cap = "(ref:fig-trib-spawn)"}
knitr::include_graphics(here::here("csasdown/figure/trib-escape.png"))
```


(ref:fig-run-timing) Average annual daily passage (scaled to maximum) from the U.S. into Canada on the mainstem Yukon River for eight Conservation Units. The Big Salmon Conservation Unit is not shown because it cannot be seperated out from the Middle Mainstem Conservation Unit based on genetics. For reference, in a non-leap year the 180th, 210th and 240th day of the year correspond to 29 June, 29 July, and 28 August, respectively. The dashed line represents the approximate average peak run-timing for the stock aggregate.

```{r fig-run-timing, fig.cap = "(ref:fig-run-timing)"}
knitr::include_graphics(here::here("csasdown/figure/CU-run-timing.png"))
```


(ref:fig-trib-vs-CU-spawn) Relationship between estimates of spawner abundance from select tributary scale assessment projects and run-reconstruction based estimates at the Conservation Unit scale. Linear model fit shown in grey. For more details on each assessment project and corresponding Conservation Units see Table \@ref(tab:assess-proponents).

```{r fig-trib-vs-CU-spawn, fig.cap = "(ref:fig-trib-vs-CU-spawn)"}
knitr::include_graphics(here::here("csasdown/figure/RR-vs-trib-spawners.png"))
```

\clearpage
(ref:fig-CU-spawn) Reconstructed spawner abundance over time by Conservation Unit (median and 95% confidence intervals).

```{r fig-CU-spawn, fig.cap = "(ref:fig-CU-spawn)"}
knitr::include_graphics(here::here("csasdown/figure/cu-escape.png"))
```

\clearpage

(ref:fig-CU-comps) Percentage contribution of each Conservation Unit (CU) to reconstructed total return abundance of the Yukon Chinook salmon Stock Management Unit over time. Estimates are based on the multi-CU run-reconstruction model that explicitly accounts for missing years and the sometimes unrepresentative genetic sampling of total returns. 

```{r fig-CU-comps, fig.cap = "(ref:fig-CU-comps)"}
knitr::include_graphics(here::here("csasdown/figure/percent-cc-contribution.png"))
```
\clearpage

(ref:fig-CU-SR) Relationship between spawner abundance and recruitment by Conservation Units. Individual spawner-recruitment pairs are color coded according to brood year with lines representing 80% credible intervals. The thick black line is the predicted median relationship between spawner abundance and recruitment along with 80% credible intervals in the shaded region. The replacement line, where spawners equal recruits, is shown in grey. 

```{r fig-CU-SR, fig.cap = "(ref:fig-CU-SR)"}
knitr::include_graphics(here::here("csasdown/figure/SR_fits_AR1.png"))
```

(ref:fig-par-ref-hist) Conservation Unit specific posterior distributions of estimates of intrinsic productivity (a;$\alpha$ in units of recruits-per-spawner), spawner abundance associated with maximum recruitment (b; $S_{MSR}$), and exploitation rate associated with maximum sustainable yield (c; $U_{MSY}$)  . 

```{r fig-par-ref-hist, fig.cap = "(ref:fig-par-ref-hist)"}
knitr::include_graphics(here::here("csasdown/figure/par-ref-hist.png"))
```


(ref:fig-prod-trends) Estimated average intrinsic productivity (Ricker $\alpha$ parameter; maximum recruits per spawner) over time by Conservation Unit in the Yukon Chinook Salmon Stock Management Unit. The dashed grey line is replacement (recruits equal spawners).

```{r fig-prod-trends, fig.cap = "(ref:fig-prod-trends)"}
knitr::include_graphics(here::here("csasdown/figure/changing_productivity.png"))
```

(ref:fig-asl) Age, sex, length, and reproductive output trends in Yukon Chinook salmon over time. a) sex ratio, represented as proportion of spawners that are female, b) body length of female spawners by age (mid eye to tail fork length), c) proportion of returning spawners in each age class over time, d) average reproductive output of female spawners (eggs per female spawner). Data taken from fish sampled at Eagle and White and Sheep rocks.  

```{r fig-asl, fig.cap = "(ref:fig-asl)"}
knitr::include_graphics(here::here("csasdown/figure/asl.png"))
```

(ref:fig-CU-EMR) Relationship between total egg mass of spawning females and recruitment by Conservation Units. Individual egg mass-recruitment pairs are color coded according to brood year with 80% credible intervals. The thick black line is the predicted median relationship between egg mass and recruitment along with 80% credible intervals in the shaded region.

```{r fig-CU-EMR, fig.cap = "(ref:fig-CU-EMR)"}
knitr::include_graphics(here::here("csasdown/figure/EM-R_fits.png"))
```

(ref:fig-em-vs-spw-sr-TVA) Scaled trends in intrinsic productivity index for two alternative spawner-recruitment (SR) models.

```{r fig-em-vs-spw-sr-TVA, fig.cap = "(ref:fig-em-vs-spw-sr-TVA)"}
knitr::include_graphics(here::here("csasdown/figure/spw-vs-em-SR-TVA.png"))
```

(ref:fig-rapid-status) Yukon Chinook Wild Salmon Policy statuses for years with applicable data. Each row summarizes the statuses available for each Conservation Unit in the Yukon River and Porcupine Stock Management Units.

```{r fig-rapid-status, fig.cap = "(ref:fig-rapid-status)"}
knitr::include_graphics(here::here("csasdown/figure/rapid-status.png"))
```

(ref:fig-smu-trends) Reconstructed (a) total run size (orange) and spawning escapement (grey), and (b) harvest rates for the Yukon Chinook salmon Stock Management Unit. Thick lines are medians and shaded areas indicate 95% credible intervals. Note that harvest rate in some years (e.g., 2017 and 2019) may be overestimated due to spawning migration mortality that was unaccounted for in the model that was used to estimate them [@connors_estimates_2023].  

```{r fig-smu-trends, fig.cap = "(ref:fig-smu-trends)"}
knitr::include_graphics(here::here("csasdown/figure/SMU-run-esc.png"))
```

(ref:fig-enhance-proj) Total Chinook salmon releases by facility/type and Conservation Unit. Note: Location of brood collection and release location, by CU, are the same in all cases except for 
\~250,000 fry from the Upper Yukon that were released in the Tatchun River (Middle Yukon CU) between 2006--2011.

```{r fig-enhance-proj, fig.cap = "(ref:fig-enhance-proj)"}
knitr::include_graphics(here::here("csasdown/figure/hatch_bar.png"))
```

(ref:fig-wh-fishway) Chinook returns to Whitehorse Rapids fishway and proportion hatchery origin spawners (pHOS), based on observed adipose fin clip rates. Proportionate Natural Influence (PNI) for the last six years, calculated from adipose fin clip status and Parentage Based Tagging (PBT) results of broodstock, when available. 

```{r fig-wh-fishway, fig.cap = "(ref:fig-wh-fishway)"}
knitr::include_graphics(here::here("csasdown/figure/hatch_prop.png"))
```

(ref:fig-schematic) Illustration of steps in the closed loop simulations that were used to quantify future biological and fishery consequences of current and alternative harvest management measures.

```{r fig-schematic, fig.cap = "(ref:fig-schematic)"}
knitr::include_graphics(here::here("csasdown/figure/sim-schematic.png"))
```

(ref:fig-prod-scenarios) Alternative operating model productivity scenarios considered in the closed-loop simulations including the reference (base case) scenario, the 10-year average of recent $\alpha$ (2007--2017 brood years), and robustness scenario, the most recent $\alpha$ (2017 brood year).
```{r fig-prod-scenarios, fig.cap = "(ref:fig-prod-scenarios)"}
knitr::include_graphics(here::here("csasdown/figure/OM-productivity-scenarios.png"))
```

(ref:fig-hcrs) Illustration of the suite of harvest control rules considered in the closed-loop simulations. See Table \@ref(tab:hcrs) for description of each harvest control rule. The x-axis range in the plot corresponds approximately to the historical range of Yukon Chinook salmon run sizes.

```{r fig-hcrs, fig.cap = "(ref:fig-hcrs)"}
knitr::include_graphics(here::here("csasdown/figure/HCR_visualize.png"))
```
\clearpage

(ref:fig-projections) Projected spawner abundance over time (median and 50th percentiles) by Conservation Unit under three alternative fishery management measures, and the reference (base case) operating model productivity scenario. The last 6 years of observed spawners are shown prior to projections. Red and green dashed lines correspond to proposed lower and upper biological reference points for each CU (20%$S_{MSR}$ and $S_{MSR}$, respectively) based on analyses that explicitly took demographic characteristics into account. 

```{r fig-projections, fig.cap = "(ref:fig-projections)"}
knitr::include_graphics(here::here("csasdown/figure/S-fwd_simple_grp_TVA.png"))
```

\clearpage

(ref:fig-ER-tradeoff-ref) Projected consequences of a range of fixed exploitation rates from the closed loop simulations under the 'reference' (base case) operating model scenario. (a) Mean number of Conservation Units that fall above, below, and between their reference points (20% $S_{MSR}$ and $S_{MSR}$ based on analyses that explicitly took demographic characteristics into account) in the final simulated year (2050), over 1000 iterations. (b) Mean spawner abundance and (c) mean harvest, by Conservation Units, over all simulation years (2025--2050).

```{r fig-ER-tradeoff-ref, fig.cap = "(ref:fig-ER-tradeoff-ref)"}
knitr::include_graphics(here::here("csasdown/figure/fixed_ER_tradeoffs_TVA.png"))
```

\clearpage

(ref:fig-perf-ref) Performance of alternative harvest control rules the reference (base case) operating model productivity scenario. (a) Median (coloured bars) and 50% quantiles (vertical lines) of performance measures calculated over the years 2030--2050 and 1000 replicate simulations. (b) Mean number of Conservation Units that fall above, below, and between reference points (20%$S_{MSR}$ and $S_{MSR}$ based on analyses that explicitly took demographic characteristics into account) in the final simulated year (2050), over replicate simulations.

```{r fig-perf-ref, fig.cap = "(ref:fig-perf-ref)"}
knitr::include_graphics(here::here("csasdown/figure/perf_metrics_status_TVA.png"))
```

\clearpage



# TABLES

(ref:tab-cons-unit-smu) Stock Management and Conservation Units that make up the Yukon Chinook salmon major fish stock prescribed under the Fish Stock Provisions of Canada's *Fisheries Act*. The average annual percentage contribution of each Conservation Unit to the Yukon Chinook salmon Stock Management Unit based on reconstructed border passage is also shown. 
```{r tab-cons-unit-smu, results='asis'}
smucutable <- read.csv(here::here("csasdown/data/tab-cons-unit-smu.csv"))
names(smucutable) <- gsub("\\.", " ", names(smucutable))
names(smucutable)[4] <- "Average Contribution (1984-2024)"
names(smucutable)[3] <- "Conservation Unit"
names(smucutable)[2] <- "Conservation Unit ID"


smucutable |> 
  mutate(`Stock Management Unit` = str_to_title(`Stock Management Unit`)) |>
  dplyr::mutate_all(function(x){gsub("\\\\.", " ", x)}) |>
  dplyr::mutate_all(function(x){gsub("\\\\n","\n", x)}) |>
  dplyr::mutate_all(function(x){gsub("%", "\\\\%", x)}) |>
  csasdown::csas_table(format = "latex",
                       escape = FALSE,
                     caption = "(ref:tab-cons-unit-smu)", 
                     repeat_header = TRUE,
                     linesep = "\\addlinespace") |>
    kableExtra::column_spec(1, width = "3cm")|>
    kableExtra::column_spec(2, width = "2cm")|>
    kableExtra::column_spec(3, width = "4cm")|>
    kableExtra::column_spec(4, width = "2cm") 
```

\clearpage

\begin{landscapepage}
(ref:assess-proponents) Adult Chinook salmon assessment projects in the Canadian portion of the Yukon River basin.  

```{r assess-proponents, results = "asis"}

assess_tbl <- read.csv(file=here::here("csasdown/data/trib-assessment-proponents.csv")) |> select(-Contemporary.initiation)
names(assess_tbl) <- gsub(".", " ", names(assess_tbl), fixed=TRUE)
names(assess_tbl)[4] <- "Conservation Unit"

assess_tbl |> 
  mutate_at(c(2,5), function(x){str_to_sentence(x)}) |>
  drop_na() |> 
  
  csasdown::csas_table(format = "latex",
                       caption = "(ref:assess-proponents)",
                       repeat_header = TRUE,
                       align = "llc",
                       linesep = "\\addlinespace") |>
  kableExtra::column_spec(1, width = "3cm") |>
  kableExtra::column_spec(2, width = "3cm") |>
  kableExtra::column_spec(3, width = "7cm") |>
  kableExtra::column_spec(4, width = "3cm") |>
  kableExtra::column_spec(5, width = "2cm") |>
  kableExtra::column_spec(6, width = "3cm")|>
  kableExtra::footnote(general=c("*Project provides in-season information on returning spawners."))
```
\end{landscapepage}

\clearpage

(ref:benchmarks) Definitions, values, and rationale for proposed biological benchmarks and rebuilding targets at the Conservation Unit (CU) scale.

```{r benchmarks, results = "asis"}
bench.df <- data.frame(Metric = c("Lower biological benchmark ", 
                                  "Upper biological benchmark ",
                                  "Rebuilding target"), 
                        Definition = c("Spawner abundances below which CU is expected to have high risk of irreversible harm and which aligns with a Committee on the Status of Endangered Wildlife in Canada (COSEWIC) assessment of “endangered”", 
                                     "Spawner abundances associated with low risk of irreversible harm, delineatinating amber and green Wild Salmon Policy biological status zones",
                                     "Spawner abundances associated with a “healthy” state that meets socio-ecological objectives and is expected to be resilient in the face of rapid and unpredictable environmental change"),
                       Value = c("20% of $S_{MSR}$",
                                          "40% of $S_{MSR}$",
                                          "$S_{MSR}$ based on demographic characteristics of spawners in most recent generation (2019-2024)"),
                       Rationale = c("More biologically based than MSY based biological benchmarks that are implicitly tied to yield based objectives (Frid et al. 2023). Less sensitive to temporal variation in intrinsic productivity than MSY based benchmarks (Holt and Michielsens 2020). Aligned with proposed use of $S_{MSR}$ based reference points at SMU scale",
                       "Same as above",
                       "Targets linked to stock size greater than those associated with MSY, and that take demographics into account, have been argued to be more consistent with indigenous and ecosystem based principles and to afford greater resilience to environmental and ecosystem change (Reid et al. 2022; Frid et al 2023)"))

bench.df |>
   dplyr::mutate_all(function(x){gsub("&", "\\\\&", x)}) |> 
   dplyr::mutate_all(function(x){gsub("%", "\\\\%", x)}) |>
   dplyr::mutate_all(function(x){gsub("\\\\n","\n", x)}) |>
  csasdown::csas_table(format = "latex",
                     caption = "(ref:benchmarks)", 
                     repeat_header = TRUE) |>
    kableExtra::column_spec(1, width = "2.5cm")|>
    kableExtra::column_spec(2, width = "5cm")|>
    kableExtra::column_spec(3, width = "3cm")|>
    kableExtra::column_spec(4, width = "5cm")
```

(ref:refpoints) Definitions, values, and rationale for proposed reference points for the Yukon Stock Management Unit (SMU).

```{r refpoints, results = "asis"}
ref.df <- data.frame(Metric = c("Limit Reference Point (LRP) ", 
                                  "Upper Stock Reference Point (USR)",
                                  "Maximum Removal Reference (RR)",
                                  "Fishery Reference Point - Lower (FRP-L)"), 
                        Definition = c("Point below which serious harm may occur to the stock and where there may also be impacts to the ecosystem, associated species, and/or a long-term loss of fishing opportunities",
                                       "Stock size with a low probability of the stock dropping below it's LRP, and a target for meeting biological and/or socio-economic objectives",
                                       "The maximum acceptable harvest rate the SMU can be subject to",
                                       "Aggregate SMU spawner abundance below which fishery removals should be limited to the maximum extent possible"),
                       Value = c("One or more component CUs for the MSU in Wild Salmon Policy Red status zone",
                                 "86,000 spawners; median estimate of $S_{MSR}$ for the SMU based on demographic characteristics of spawners (and impacts on total egg mass) in most recent decade (2009-2019) at time of analysis (Connors et al. 2022)",
                                 "40%; Harvest rate associated with MSY ($U_{MSY}$) for the least productive CU in the SMU",
                                 "25,000 spawners; average SMU spawner abundance associated with no greater than 50% chance of at least one CU falling in the Wild Salmon Policy Red status zone"),
                     Rationale = c("Required under Fish Stock Provision of *Fisheries Act*. Reflects requirement for salmon LRPs to be aligned with Wild Salmon Policy objective of preserving biodiversity of salmon at the scale of CUs (Holt et al. 2023)",
                                   "Required under Fish Stock Provision of *Fisheries Act*. Reference points linked to stock size greater than those associated with MSY, and that take demographics into account, have been argued to be more aligned with indigenous and ecosystem based principles (Reid et al. 2022; Frid et al 2023). Consistent with use of $S_{MSR}$ as border passage target under current Yukon River 7-year agreement",
                                   "Required under Fish Stock Provision of *Fisheries Act*. Federal and international fishery policy typically set maximum fishery removals to be less than or equal to those associated with $U_{MSY}$. Propose this value be from least productive CU to align with Wild Salmon Policy objective to takee biodiversity at the scale of CUs into account",
                                   "not required under Fish Stock Provision of Fisheries Act but helpful for informing management since assessment and fishery decisions are often abundance based and so can be operationalized (compared to the CU-status based LRP)"))

ref.df |>
   dplyr::mutate_all(function(x){gsub("&", "\\\\&", x)}) |> 
   dplyr::mutate_all(function(x){gsub("%", "\\\\%", x)}) |>
   dplyr::mutate_all(function(x){gsub("\\\\n","\n", x)}) |>
  csasdown::csas_table(format = "latex",
                     caption = "(ref:refpoints)", 
                     repeat_header = TRUE) |>
    kableExtra::column_spec(1, width = "2.5cm")|>
    kableExtra::column_spec(2, width = "4cm")|>
    kableExtra::column_spec(3, width = "4cm")|> 
    kableExtra::column_spec(4, width = "4cm")
```

\clearpage
(ref:pars-ref-pts) Estimates of biological reference points by Conservation Unit. Values are in thousands of fish (except $U_{MSY}$).

```{r pars-ref-pts, results = "asis"}
bench.pars <- read.csv(here::here('analysis/data/generated/bench_par_table.csv'))


CU_name_lookup <- data.frame(CU = c("NorthernYukonR.andtribs.", 
              "Whiteandtribs.", "Stewart",  
              "MiddleYukonR.andtribs.","Pelly",
              "Nordenskiold", "Big.Salmon", 
              "UpperYukonR.","YukonR.Teslinheadwaters"), 
                CU_pretty = c("Northern Yukon R. and tribs.", 
                "White and tribs.", "Stewart",  
                "Middle Yukon R. and tribs.","Pelly",
                "Nordenskiold", "Big Salmon", 
                "Upper Yukon R.","Yukon R. Teslin Headwaters"))


bench.pars[bench.pars$bench.par != "Umsy", 3:6] <- bench.pars[bench.pars$bench.par != "Umsy", 3:6]/1000

bench.pars <- bench.pars |> 
  dplyr::mutate_at(3:6, function(x){round(x, 2)}) |>
  dplyr::mutate(value=paste0(X50., " (", X10., ",", X90., ")")) |>
  dplyr::relocate(value, .after=bench.par) |>
  dplyr::mutate(Rhat = format(round(Rhat, 4))) |>
  dplyr::left_join(CU_name_lookup, by="CU") |>
  dplyr::relocate(CU_pretty, .before=bench.par) |>
  dplyr::select(-CU)



bench.pars$bench.par[bench.pars$bench.par == "Sgen"]<- "$S_{\\text{GEN}}$"
bench.pars$bench.par[bench.pars$bench.par == "Smsr"]<- "$S_{\\text{MSR}}$"
bench.pars$bench.par[bench.pars$bench.par == "Smsy"]<- "$S_{\\text{MSY}}$"
bench.pars$bench.par[bench.pars$bench.par == "Umsy"]<- "$U_{\\text{MSY}}$"

names(bench.pars) <- c("Conservation Unit",
                       "Reference Point",
                       "Median (80$^{\\text{th}}$ percentile)",
                       "Mean", "Median",
                       "Quantile 10", "Quantile 90", 
                       "Effective Sample Size ($N_{\\text{eff}}$)",
                       "Chain Mixing ($\\widehat{R}$)")

bench.pars |> 
  dplyr::filter(`Reference Point` %in% c("$S_{\\text{GEN}}$", "$S_{\\text{MSR}}$", "$S_{\\text{MSY}}$", "$U_{\\text{MSY}}$")) |>
  dplyr::arrange(`Conservation Unit`) |>
  dplyr::select(c(1:3)) |>
  dplyr::mutate_all(function(x){gsub("&", "\\\\&", x)}) |> 
  dplyr::mutate_all(function(x){gsub("%", "\\\\%", x)}) |>
  dplyr::mutate_all(function(x){gsub("\\\\n","\n", x)}) |>
  csasdown::csas_table(format = "latex",
                     caption = "(ref:pars-ref-pts)", 
                     repeat_header = TRUE,
                     align = "llc",
                     booktabs = T) |>
  kableExtra::collapse_rows(columns=1, latex_hline = "major")
  

```


\clearpage
(ref:pars-sr) Estimates of key spawner-recruitment relationship parameters by Conservation Unit along with two measures of parameter estimability and model convergence. Estimates of $\beta$ are on the scale of 10,000 fish for ease of summarizing parameters in the table.

```{r pars-sr, results = "asis"}
bench.pars <- read.csv(here::here('analysis/data/generated/bench_par_table.csv'))

CU_name_lookup <- data.frame(CU = c("NorthernYukonR.andtribs.", 
              "Whiteandtribs.", "Stewart",  
              "MiddleYukonR.andtribs.","Pelly",
              "Nordenskiold", "Big.Salmon", 
              "UpperYukonR.","YukonR.Teslinheadwaters"), 
                CU_pretty = c("Northern Yukon R. and tribs.", 
                "White and tribs.", "Stewart",  
                "Middle Yukon R. and tribs.","Pelly",
                "Nordenskiold", "Big Salmon", 
                "Upper Yukon R.","Yukon R. Teslin Headwaters"))

bench.pars$bench.par <- gsub(".", "", bench.pars$bench.par, fixed=TRUE)

bench.pars <- bench.pars |> 
  dplyr::mutate_at(3:6, function(x){round(x, 2)}) |>
  dplyr::mutate(value=paste0(X50., " (", X10., ",", X90., ")")) |>
  dplyr::relocate(value, .after=bench.par) |>
  dplyr::mutate(Rhat = format(round(Rhat, 4))) |>
  dplyr::left_join(CU_name_lookup, by="CU") |>
  dplyr::relocate(CU_pretty, .before=bench.par) |>
  dplyr::select(-CU)

  

names(bench.pars) <- c("Conservation Unit",
                       "Parameter",
                       "Median (80$^{\\text{th}}$ percentile)",
                       "Mean", "Median",
                       "Quantile 10", "Quantile 90", 
                       "Effective Sample Size ($N_{\\text{eff}}$)",
                       "Chain Mixing ($\\widehat{R}$)")
bench.pars$Parameter[bench.pars$Parameter == "alpha"]<- "$\\alpha$"
bench.pars$Parameter[bench.pars$Parameter == "beta"]<- "$\\beta$"
bench.pars$Parameter[bench.pars$Parameter == "phi"]<- "$\\phi$"
bench.pars$Parameter[bench.pars$Parameter == "sigma"]<- "$\\sigma$"

bench.pars |> 
  dplyr::select(c(1:3,8:9)) |>
  dplyr::filter(Parameter %in% c("$\\alpha$", "$\\beta$", "$\\phi$", "$\\sigma$")) |>
  dplyr::arrange(`Conservation Unit`) |>
  dplyr::mutate_all(function(x){gsub("&", "\\\\&", x)}) |> 
  dplyr::mutate_all(function(x){gsub("%", "\\\\%", x)}) |>
  dplyr::mutate_all(function(x){gsub("\\\\n","\n", x)}) |>
  csasdown::csas_table(format = "latex",
                     caption = "(ref:pars-sr)", 
                     repeat_header = TRUE,
                     align = "llc") |>
  kableExtra::collapse_rows(columns=1, latex_hline = "major") |>
  kableExtra::column_spec(1, width = "4cm") |>
  kableExtra::column_spec(3, width = "3cm") |>
  kableExtra::column_spec(4:5, width = "2cm") |>
  kableExtra::row_spec(1:108, align = "c")
  

```

\clearpage

(ref:demo-ref-pts) Biological reference points based on estimated egg mass-recruitment relationships by Conservation Unit. Values are in thousands of fish, and shown are reference points assuming different age, size and sex composition observed in the first six years of time series ("Early"), last six years of time series ("Recent"), or averaged over all years .

```{r demo-ref-pts, results = "asis"}
demo.pars <- read.csv(here::here('analysis/data/generated/demographic_parameters.csv'))

CU_name_lookup <- data.frame(CU = c("NorthernYukonR.andtribs.", 
              "Whiteandtribs.", "Stewart",  
              "MiddleYukonR.andtribs.","Pelly",
              "Nordenskiold", "Big.Salmon", 
              "UpperYukonR.","YukonR.Teslinheadwaters"), 
                CU_pretty = c("Northern Yukon R. and tribs.", 
                "White and tribs.", "Stewart",  
                "Middle Yukon R. and tribs.","Pelly",
                "Nordenskiold", "Big Salmon", 
                "Upper Yukon R.","Yukon R. Teslin Headwaters"))

demo.pars <- demo.pars |> 
  dplyr::mutate(period = dplyr::case_when(period == "avg" ~ "Average (all years)",
                                          period == "early" ~ "Early (1985-1990)",
                                          period == "recent" ~ "Recent (2019-2024)")) |>
  mutate_at(4:6, function(x){round(x/1000, 2)}) |>
  dplyr::mutate(`Median (80$^{\\text{th}}$ percentile)` = paste0(median, " (", lower, ",", upper, ")")) |>
  dplyr::left_join(CU_name_lookup, by="CU") |>
  dplyr::relocate(CU_pretty, .before=period) |>
  dplyr::select(-CU)

demo.pars$par[demo.pars$par == "Sgen"]<- "$S_{\\text{GEN}}$"
demo.pars$par[demo.pars$par == "Smsr"]<- "$S_{\\text{MSR}}$"
demo.pars$par[demo.pars$par == "Smsy"]<- "$S_{\\text{MSY}}$"

names(demo.pars)[1:6] <- c("Conservation Unit",
                           "Period",
                           "Reference Point",
                           "Median",
                           "Lower Quantile", "Upper Quantile")
demo.pars |> 
  dplyr::select(c(1:3,7)) |>
  dplyr::relocate(`Reference Point`, .after=`Conservation Unit`) |>
  dplyr::arrange(`Conservation Unit`) |>
  dplyr::mutate_all(function(x){gsub("&", "\\\\&", x)}) |> 
  dplyr::mutate_all(function(x){gsub("%", "\\\\%", x)}) |>
  dplyr::mutate_all(function(x){gsub("\\\\n","\n", x)}) |>
  csasdown::csas_table(format = "latex",
                     caption = "(ref:demo-ref-pts)", 
                     repeat_header = TRUE,
                     align = "llc") |>
  kableExtra::collapse_rows(columns=1, latex_hline = "major")

```

\clearpage

(ref:tab-factors-summary) Summary of anthropogenic, ecosystem, and climate factors affecting hypothesized to influence Yukon Chinook salmon.

```{r tab-factors-summary, results="asis"}
# spawners
factors_spwn <- c("Water temperature", "Discharge/flow levels",
             "Ichthypohonus hoferi (pathogen)", "Thiamine deficiency complex (TDC)")
desc_spwn <- c("Temperatures >18C cause heat stress and impact spawning success",
               "Low flow reduce spawning success via higher temperature, habitat fragmentation",
               "Primarily infects maturing adults in the marine environment, potentially high mortality during spawning migration",
               "Low thiamine in adults has transgenerational effects")
refs_spwn <- c("Feddern et al. 2024; Murdoch et al. 2024", "Howard and von Biela 2023; Neuswanger et al. 2015", "Carroll and Liller 2023; Murphy et al. 2023; 2024; Kocan et al. 2004", "Larson and Howard 2019; Howard and von Biela 2023")

  
# egg  
factors_egg <- c("Stream flow", "Winter stream temperature")
desc_egg <- c("High flows scour streambeds, reducing egg survival ",
              "Cold and/or long winters reduce incubation survival")
refs_egg <- c("Feddern et al. 2024", "Murdoch et al. 2020; 2024")

# fry / smolt
factors_frysmolt <- c("Aufeis (icing)", "Stream flow / precipitation", 
                      "Ice out date", "Hydroelectric dam", "Placer mining")
desc_frysmolt <- c("Reduced or halted streamflow from ice formations decreases fry survival",
                   "High streamflow (high precipitation) may reduce foraging efficiency", 
                   "Early ice-out allows earlier outmigration", 
                   "Fry/smolts pass through dam, decreasing downstream survival",
                   "Sediment deposition and suspension can decrease egg and fry survival")
refs_frysmolt <- c("von Finster et al. 2025; in press", "Murdoch et al. 2024; Feddern et al. 2024", "Murdoch et al. 2024; Cunningham et al. 2018; Feddern et al. 2024", "Twardek et al. 2023b","Jensen et al. 2009; von Finster et al. in press")

# juvenile
factors_juvenile <- c("Sea surface temperature - winter", "Sea ice cover", "Predation")
desc_juvenile <- c("Colder first winters result in less productivity", 
                   "Productivity is lower in years when ice persists in the Bering Sea later",
                   "Increase in apex predator abundance")
refs_juvenile <- c("Feddern et al. 2024", "Feddern et al. 2024; Murdoch et al. 2024", "Ohlberger et al. 2019")

# adults
factors_adult <- c("Pink salmon competition", "Prey quality")
desc_adult <- c("Abundant pink salmon cause trophic cascades in the Bering Sea",
                "Declining prey quality in the Eastern Bering Sea hypothesized to be the cause of thiamine deficiency in spawning adults")
refs_adult <- c("Ruggerone et al. 2016; Cunningham et al. 2018", "Howard and von Biela 2023")

# make whole table
factors.df <- data.frame("Life_stage" = c(rep("Spawner", length(factors_spwn)),
                                        rep("Egg", length(factors_egg)),
                                        rep("Fry / smolt", length(factors_frysmolt)),
                                        rep("Juvenile", length(factors_juvenile)),
                                        rep("Adult", length(factors_adult))
                                        ),
                         "Anthropogenic,_ecosystem,_or_climate_factor" = 
                           c(factors_spwn, factors_egg, factors_frysmolt, 
                             factors_juvenile, factors_adult),
                         "Description_or_hypothesis" = c(desc_spwn, desc_egg, 
                                                         desc_frysmolt, desc_juvenile,
                                                         desc_adult),
                         "References" = c(refs_spwn, refs_egg, refs_frysmolt, refs_juvenile, refs_adult)
                         )

names(factors.df) <- gsub("_", " ", names(factors.df))
names(factors.df) <- gsub(".", ",", names(factors.df), fixed = TRUE)


factors.df |>
  dplyr::mutate_all(function(x){gsub("\\\\.", " ", x)}) |>
  dplyr::mutate_all(function(x){gsub("\\\\n","\n", x)}) |>
  csasdown::csas_table(format = "latex",
                       escape = FALSE,
                     caption = "(ref:tab-factors-summary)", 
                     repeat_header = TRUE,
                     linesep = "\\addlinespace") |>
    kableExtra::column_spec(1, width = "2cm")|>
    kableExtra::column_spec(2, width = "3cm")|>
    kableExtra::column_spec(3, width = "6.5cm")|>
    kableExtra::column_spec(4, width = "5cm") |>
    kableExtra::collapse_rows(columns=1, latex_hline = "major")
```


\clearpage
(ref:hcrs) Descriptions of the alternative fishery management measures (aka Harvest Control Rules) considered in the closed loop simulations.

```{r hcrs, results = "asis"}
HCR.df <- data.frame(HarvestControlRule = c("Moratorium", 
                                               "IMEG", 
                                               "Moratorium w/ harvest cap", 
                                               "IMEG w/ harvest cap", 
                                               "Precationary Approach (PA) alternative"), 
                        Description = c("Current moratorium on all directed harvest unless run-sizes are forecast to exceed 71,000 fish \n", 
                                     "Interim Management Escapement goal (IMEG) that was in place prior to the current moratorium. At forecasts below 42,500 fish no directed harvest and target harvest equal to 'surplus' if forecast exceeds escapement goal \n", 
                                     "Current moratorium unless run-sizes are forecast to exceed 71,000 fish in which case there is a harvest rate cap at large run-sizes that is equal to $U_{MSY}$ of the least productive Conservation Unit \n", 
                                     "Interim Management Escapement goal with a harvest rate cap at large run-sizes that is equal to $U_{MSY}$ of the least productive Conservation Unit (~40%) \n",
                                     "Harvest Control Rule that is consistent with DFO's Precautioanry Approach Framework (DFO 2009): no harvest below lower fishery reference point [19,000] with progressive increase in allowable harvest rate up to maximum equal to $U_{MSY}$ of the least productive Conservation Unit when run-sizes reach spawner abundances associated with the Upper Stock Reference Point (95,000) \n"))

colnames(HCR.df)[1] <- "Harvest Control Rule"

HCR.df |>
   dplyr::mutate_all(function(x){gsub("&", "\\\\&", x)}) |> 
   dplyr::mutate_all(function(x){gsub("%", "\\\\%", x)}) |>
   dplyr::mutate_all(function(x){gsub("\\\\n","\n", x)}) |>
  csasdown::csas_table(format = "latex",
                     caption = "(ref:hcrs)", 
                     repeat_header = TRUE) |>
    kableExtra::column_spec(1, width = "4cm")|>
    kableExtra::column_spec(2, width = "10cm")
```

\clearpage

(ref:tab-perf-metrics-descriptions) Biological and fishery performance measures considered in the closed-loop simulations to assess the performance of alternative fishery management measures.

```{r tab-perf-metrics-descriptions, results = "asis"}
df <- data.frame(Metric = c("Number of CUs below their lower biological reference point", 
                            "Number of CUs above their upper biological reference point", 
                            "Average annual aggregrate spawning escapement", 
                            "Average annual harvest", 
                            "Average annual harvest rate", 
                            "Proportion of years with no harvest", 
                            "Proportion of years Basic Needs Allocation met"), 
                 Description = c("Number of Conservation Units (CUs; $i$) with spawner abundance ($S$) at end of simulations that falls below CU specific lower biological refernece point, defined as 20% of the spawner abundance associated with maximum returns when demographic characteristics over most recent decade are explicitly taken into account (20%$S_{MSR,em_{2014-2024}}$)",
                                 "Number of Conservation Units (CUs) with spawner abundance at end of simulations that is above CU specific upper biological refernece point, defined as spawner abundance associated with maximum returns when demographic characteristics over most recent decade are explicitly taken into account ($S_{MSR,em_{2014-2024}}$)",
                                  "Average spawner abundance across all CUs across replicate simulation and years, where $n$ rep is the number of replicate simulations and $t_1$ and $t_2$ are the first and last years over which the metric is calculated", 
                                  "Average annual harvest ($H$) across all CUs across replicate simulation and years", 
                                  "Average annual harvest rate ($U$) for stock aggregate across replicate simulation and years", 
                                  "Proportion of years across replicate simulation and years with no harvest", 
                                  "Proportion of years across replicate simulation and years Basic Needs Allocation (BNA)met"),
                 Equation = c("$\\sum_i S_{i,t=2050}<0.2S_{MSR,i,em_{2014-2024}}$", 
                              "$\\sum_i S_{i,t=2050}>S_{MSR,i,em_{2014-2024}}$", 
                              "$\\frac{\\sum_i\\sum_{\\substack{n_{rep}\\\\n=1}}\\sum_{\\substack{t_1\\\\t_2}}S_{i,t}}{t_2-t_1+1}$", 
                              "$\\frac{\\sum_i\\sum_{\\substack{n_{rep}\\\\n=1}}\\sum_{\\substack{t_1\\\\t_2}}H_{i,t}}{t_2-t_1+1}$", 
                              "$\\frac{\\sum_{\\substack{t_1\\\\t_2}}U_{t}}{t_2-t_1+1}$",
                              "$\\frac{\\sum_i\\sum_{\\substack{n_{rep}\\\\n=1}}\\sum_{\\substack{t_1\\\\t_2}}H_{i,t}=0}{t_2-t_1+1}$",
                              "$\\frac{\\sum_i\\sum_{\\substack{n_{rep}\\\\n=1}}\\sum_{\\substack{t_1\\\\t_2}}H_{i,t}>BNA}{t_2-t_1+1}$"))
df|>
   dplyr::mutate_all(function(x){gsub("&", "\\\\&", x)}) |> 
   dplyr::mutate_all(function(x){gsub("%", "\\\\%", x)}) |>
   dplyr::mutate_all(function(x){gsub("\\\\n","\n", x)}) |>
  csasdown::csas_table(format = "latex",
                     caption = "(ref:tab-perf-metrics-descriptions)", 
                     repeat_header = TRUE, 
                     align = "llc")|>
  kableExtra::column_spec(1, width = "3.5cm")|>
  kableExtra::column_spec(2, width = "6.5cm")
```
\clearpage


\begin{landscapepage}
(ref:tab-ref-perf-measures) Consequences of alternative Harvest Control Rules based on range of biological and fishery performance measures (Table 10) under the reference (base case) productivity operating model scenario. Lower Stock Reference (LSR) and Upper Stock Reference (USR) refer to lower and upper reference points, respectively.

```{r tab-ref-perf-measures, results = "asis"}
ref_case_pms <- read.csv(here::here("analysis/data/generated/perf_metrics_TVA.csv")) |>
  tidyr::pivot_longer(cols=2:11, values_to="value", names_to="metric") |>
  tidyr::pivot_wider(values_from="value", names_from="prob")
perf_metric_desc <- read.csv(here::here("csasdown/data/names_lookup.csv")) # to link metric names


HCR_lookup <- data.frame(HCR = c("no.fishing", "moratorium", "IMEG", "moratorium.cap", 
                                 "IMEG.cap", "PA.alternative"),
                         HCR_name = c("No fishing", "Moratorium", "IMEG", "Moratorium cap",
                                        "IMEG cap", "PA Alternative"))
fix_hcr <- unique(ref_case_pms$HCR)[grepl("^fixed.", unique(ref_case_pms$HCR))]

ref_case_pms[ref_case_pms$metric %in% c("escapement", "harvest"),3:6] <- ref_case_pms[ref_case_pms$metric %in% c("escapement", "harvest"),3:6]/1000 # put esc and harvest in units of x1000 fish

ref_case_pms <- ref_case_pms |> 
  dplyr::filter(!(HCR %in% fix_hcr)) |>  # filter out fixed harvest 
  dplyr::left_join(perf_metric_desc[,1:2], by=c("metric" = "metric_name")) |> # join metric names
  dplyr::left_join(HCR_lookup, by="HCR") |>
  dplyr::mutate_at(3:6, function(x){round(x, 2)}) |>
  dplyr::mutate(value=paste0(median, " (", q_25, ",", q_75, ")")) |>
  dplyr::select(c("HCR_name", "Metric", "mean", "value"))

names(ref_case_pms) <- c("Harvest Control Rule", "Performance measure", "Mean", "Median (50$^{\\text{th}}$ percentiles)")

ref_case_pms |> 
  dplyr::arrange(factor(`Harvest Control Rule`, levels=HCR_lookup$HCR_name)) |>
  dplyr::mutate_all(function(x){gsub("&", "\\\\&", x)}) |> 
  dplyr::mutate_all(function(x){gsub("%", "\\\\%", x)}) |>
  dplyr::mutate_all(function(x){gsub("\\\\n","\n", x)}) |>
  csasdown::csas_table(format = "latex",
                       caption = "(ref:tab-ref-perf-measures)", 
                       repeat_header = TRUE,
                       align = "llc") |>
kableExtra::collapse_rows(columns=1, latex_hline = "major")

```

\clearpage
(ref:tab-rob-perf-measures) Consequences of alternative Harvest Control Rules based on range of biological and fishery performance measures (Table 10) under the robustness (worst case) productivity operating model scenario.LSR and USR refer to lower and upper reference points, respectively.


```{r tab-rob-perf-measures, results = "asis"}
rob_case_pms <- read.csv(here::here("analysis/data/generated/perf_metrics_TVA2.csv"))|>
  tidyr::pivot_longer(cols=2:11, values_to="value", names_to="metric") |>
  tidyr::pivot_wider(values_from="value", names_from="prob")
perf_metric_desc <- read.csv(here::here("csasdown/data/names_lookup.csv")) # to link metric names

HCR_lookup <- data.frame(HCR = c("no.fishing", "moratorium", "IMEG", "moratorium.cap", 
                                 "IMEG.cap", "PA.alternative"),
                         HCR_name = c("No fishing", "Moratorium", "IMEG", "Moratorium cap",
                                        "IMEG cap", "PA Alternative"))
fix_hcr <- unique(rob_case_pms$HCR)[grepl("^fixed.", unique(rob_case_pms$HCR))]

rob_case_pms[rob_case_pms$metric %in% c("escapement", "harvest"),3:6] <- rob_case_pms[rob_case_pms$metric %in% c("escapement", "harvest"),3:6]/1000 # put esc and harvest in units of x1000 fish

rob_case_pms <- rob_case_pms |> 
 dplyr::filter(!(HCR %in% fix_hcr)) |>  # filter out fixed harvest 
  dplyr::left_join(perf_metric_desc[,1:2], by=c("metric" = "metric_name")) |> # join metric names
  dplyr::left_join(HCR_lookup, by="HCR") |>
  dplyr::mutate_at(3:6, function(x){round(x, 2)}) |>
  dplyr::mutate(value=paste0(median, " (", q_25, ",", q_75, ")")) |>
  dplyr::select(c("HCR_name", "Metric", "mean", "value"))

names(rob_case_pms) <- c("Harvest Control Rule", "Performance measure", "Mean", "Median (50$^{\\text{th}}$ percentiles)")

rob_case_pms |> 
  dplyr::arrange(factor(`Harvest Control Rule`, levels=HCR_lookup$HCR_name)) |>
  dplyr::mutate_all(function(x){gsub("&", "\\\\&", x)}) |> 
  dplyr::mutate_all(function(x){gsub("%", "\\\\%", x)}) |>
  dplyr::mutate_all(function(x){gsub("\\\\n","\n", x)}) |>
  csasdown::csas_table(format = "latex",
                       caption = "(ref:tab-rob-perf-measures)", 
                       repeat_header = TRUE,
                       align = "llc") |>
kableExtra::collapse_rows(columns=1, latex_hline = "major")


```

\clearpage
(ref:tab-rob2-perf-measures) Consequences of alternative Harvest Control Rules based on range of biological and fishery performance measures (Table 10) under the robustness (best case, long term alpha) productivity operating model scenario. LSR and USR refer to lower and upper reference points, respectively.
```{r tab-rob2-perf-measures, results = "asis"}
rob_case_pms <- read.csv(here::here("analysis/data/generated/perf_metrics_TVA3.csv"))|>
  tidyr::pivot_longer(cols=2:11, values_to="value", names_to="metric") |>
  tidyr::pivot_wider(values_from="value", names_from="prob")
perf_metric_desc <- read.csv(here::here("csasdown/data/names_lookup.csv")) # to link metric names

HCR_lookup <- data.frame(HCR = c("no.fishing", "moratorium", "IMEG", "moratorium.cap", 
                                 "IMEG.cap", "PA.alternative"),
                         HCR_name = c("No fishing", "Moratorium", "IMEG", "Moratorium cap",
                                        "IMEG cap", "PA Alternative"))
fix_hcr <- unique(rob_case_pms$HCR)[grepl("^fixed.", unique(rob_case_pms$HCR))]

rob_case_pms[rob_case_pms$metric %in% c("escapement", "harvest"),3:6] <- rob_case_pms[rob_case_pms$metric %in% c("escapement", "harvest"),3:6]/1000 # put esc and harvest in units of x1000 fish

rob_case_pms <- rob_case_pms |> 
 dplyr::filter(!(HCR %in% fix_hcr)) |>  # filter out fixed harvest 
  dplyr::left_join(perf_metric_desc[,1:2], by=c("metric" = "metric_name")) |> # join metric names
  dplyr::left_join(HCR_lookup, by="HCR") |>
  dplyr::mutate_at(3:6, function(x){round(x, 2)}) |>
  dplyr::mutate(value=paste0(median, " (", q_25, ",", q_75, ")")) |>
  dplyr::select(c("HCR_name", "Metric", "mean", "value"))

names(rob_case_pms) <- c("Harvest Control Rule", "Performance measure", "Mean", "Median (50$^{\\text{th}}$ percentiles)")

rob_case_pms |> 
  dplyr::arrange(factor(`Harvest Control Rule`, levels=HCR_lookup$HCR_name)) |>
  dplyr::mutate_all(function(x){gsub("&", "\\\\&", x)}) |> 
  dplyr::mutate_all(function(x){gsub("%", "\\\\%", x)}) |>
  dplyr::mutate_all(function(x){gsub("\\\\n","\n", x)}) |>
  csasdown::csas_table(format = "latex",
                       caption = "(ref:tab-rob-perf-measures)", 
                       repeat_header = TRUE,
                       align = "llc") |>
kableExtra::collapse_rows(columns=1, latex_hline = "major")


```
\end{landscapepage}
